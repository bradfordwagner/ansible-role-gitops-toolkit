---
# tasks file for gitops-toolkit
- set_fact:
    _gtk_argocd: "{{ gtk_argocd_defaults | combine(gtk_argocd, recursive=True) }}"
    _gtk_start_clusters: "{{ gtk_start_clusters_defaults | combine(gtk_start_clusters, recursive=True) }}"

- include_role:
    name: andrewrothstein.unarchivedeps
  when: gtk_install_dependent_binaries
- include_role:
    name: andrewrothstein.kubectl
  when: gtk_install_dependent_binaries
- include_role:
    name: andrewrothstein.argocd
  when: gtk_install_dependent_binaries

- include_tasks: install_gtk.yml
- include_tasks: install_cacert.yml

- name: cloning argocd deployment manifest from {{ _gtk_argocd.manifest.git.repo }}@{{ _gtk_argocd.manifest.git.version }} to {{ _gtk_argocd.manifest.dir }}
  when: _gtk_argocd.manifest.git.enabled
  git:
    repo: "{{ _gtk_argocd.manifest.git.repo }}"
    version: "{{ _gtk_argocd.manifest.git.version }}"
    dest: "{{ _gtk_argocd.manifest.dir }}"

- name: configuring {{ ansible_env.HOME }}/.gitops-toolkit-clusters.yaml
  become: '{{ false if is_wsl else true }}'
  # We can remove become_user as root is the default become_user
  # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_privilege_escalation.html#become-directives
  # become_user: root
  template:
    src: '{{ gtk_cluster_template_yaml }}'
    dest: '{{ ansible_env.HOME }}/.gitops-toolkit-clusters.yaml'
    # Adding a leading zero (for example, 0755) works sometimes, but can fail in loops and some other circumstances.
    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html#parameter-mode
    mode: '{{ item.m | default("644") }}'

- include_tasks: start_clusters.yml
  when: _gtk_start_clusters.enabled
